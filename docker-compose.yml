
services:
  # --- AI & LLM STACK ---
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  # --- WEB UI (Open WebUI) ---
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "3000:8080"
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
    volumes:
      - open-webui:/app/backend/data
    depends_on:
      - ollama
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  # --- WATCHTOWER (Auto-Update) ---
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_SCHEDULE=0 0 4 * * 1
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_ROLLING_RESTART=true
      - DOCKER_API_VERSION=1.44
    restart: unless-stopped

  # --- FILE SHARING ---
  copyparty:
    image: copyparty/ac
    container_name: copyparty
    restart: unless-stopped
    ports:
      - "3923:3923"
    volumes:
      - copyparty_data:/w
      - /data:/w/hdd
      - ./config/copyparty.conf:/cfg/copyparty.conf 
    environment:
      - E=idk  # Enable basic drag-and-drop upload

  # --- OBSERVABILITY (Datadog + Dozzle) ---
  datadog:
    image: datadog/agent:7
    container_name: datadog
    restart: unless-stopped
    pid: host
    environment:
      - DD_API_KEY=${DD_API_KEY}
      - DD_SITE=${DD_SITE}
      - DD_TAGS=${DD_TAGS}
      - DD_DOCKER_LABELS_AS_TAGS=true
      - DD_DOCKER_LISTEN_ON=/var/run/docker.sock
      - DD_PROCESS_AGENT_ENABLED=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, utility]

  # --- Container Logging (Dozzle) ---
  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  # --- MONITORING (Uptime Kuma) ---
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: always
    ports:
      - "3001:3001"
    volumes:
      - uptime-kuma-data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock

  # --- DASHBOARD (Homer) ---
  homer:
    image: b4bz/homer
    container_name: homer
    restart: unless-stopped
    ports:
      - "80:8080"
    volumes:
      - ./homer:/www/assets

  # --- AUTOMATION (n8n) ---
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_SECURE_COOKIE=false
    volumes:
      - n8n_data:/home/node/.n8n

  # --- AUTOMATION (Semaphore UI) ---
  semaphore:
    image: semaphoreui/semaphore:latest
    container_name: semaphore
    restart: unless-stopped
    ports:
      - "3002:3000"
    environment:
      - SEMAPHORE_DB_DIALECT=sqlite
      - SEMAPHORE_ADMIN_PASSWORD=${SEMAPHORE_ADMIN_PASSWORD}
      - SEMAPHORE_ADMIN_NAME=${SEMAPHORE_ADMIN_NAME}
      - SEMAPHORE_ADMIN_EMAIL=${SEMAPHORE_ADMIN_EMAIL}
      - SEMAPHORE_ADMIN=${SEMAPHORE_ADMIN}
    volumes:
      - semaphore_data:/etc/semaphore

  # --- DATABASE (Shared PostgreSQL) ---
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - VOX_LOOP_DB_PASSWORD=${VOX_LOOP_DB_PASSWORD}
      - COOK_BOOK_DB_PASSWORD=${COOK_BOOK_DB_PASSWORD}
    networks:
      - construct_net

  # --- APP SERVICES (separate repos, images TBD) ---
  vox-loop:
    image: ghcr.io/einlanzerous/vox-loop:latest
    container_name: vox-loop
    restart: unless-stopped
    ports:
      - "${VOX_LOOP_PORT}:${VOX_LOOP_PORT}"
    environment:
      - PORT=${VOX_LOOP_PORT}
      - DATABASE_URL=postgres://vox_loop_user:${VOX_LOOP_DB_PASSWORD}@postgres:5432/vox_loop?sslmode=disable
      - POSTGRES_USER=vox_loop_user
      - POSTGRES_PASSWORD=${VOX_LOOP_DB_PASSWORD}
      - POSTGRES_DB=vox_loop
      - POSTGRES_HOST=postgres
    volumes:
      - vox_loop_config:/etc/dendrite
      - vox_loop_media:/var/dendrite/media
    networks:
      - construct_net
    depends_on:
      - postgres

  cook_book:
    image: ghcr.io/einlanzerous/cook_book:latest
    container_name: cook_book
    restart: unless-stopped
    ports:
      - "${COOK_BOOK_PORT}:${COOK_BOOK_PORT}"
    environment:
      - PORT=${COOK_BOOK_PORT}
      - DATABASE_URL=postgres://cook_book_user:${COOK_BOOK_DB_PASSWORD}@postgres:5432/cook_book?sslmode=disable
    networks:
      - construct_net
    depends_on:
      - postgres

volumes:
  open-webui:
  ollama_data:
  n8n_data:
  copyparty_data:
  uptime-kuma-data:
  semaphore_data:
  postgres_data:
  vox_loop_config:
  vox_loop_media:

networks:
  construct_net:
    external: true