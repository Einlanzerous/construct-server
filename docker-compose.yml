
services:
  # --- AI & LLM STACK ---
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  # --- WEB UI (Open WebUI) ---
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "3000:8080"
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
    volumes:
      - open-webui:/app/backend/data
    depends_on:
      - ollama
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  # --- WATCHTOWER (Auto-Update) ---
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_SCHEDULE=0 0 4 * * 1
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_ROLLING_RESTART=true
    restart: unless-stopped

  # --- FILE SHARING ---
  # --- FILE SHARING ---
  copyparty:
    image: ucartz/copyparty
    container_name: copyparty
    restart: unless-stopped
    ports:
      - "3923:3923"
    volumes:
      - ./copyparty:/w
      - /data:/w/hdd 
    environment:
      - E=idk  # Enable basic drag-and-drop upload

  # --- OBSERVABILITY (Datadog + Dozzle) ---
  datadog:
    image: datadog/agent:7
    container_name: datadog
    restart: unless-stopped
    pid: host
    environment:
      - DD_API_KEY=${DD_API_KEY}
      - DD_SITE=${DD_SITE}
      - DD_TAGS=${DD_TAGS}
      - DD_DOCKER_LABELS_AS_TAGS=true
      - DD_DOCKER_LISTEN_ON=/var/run/docker.sock
      - DD_PROCESS_AGENT_ENABLED=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, utility]

  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  # --- DASHBOARD (Homer) ---
  homer:
    image: b4bz/homer
    container_name: homer
    restart: unless-stopped
    ports:
      - "80:8080"
    volumes:
      - ./homer:/www/assets

  # --- AUTOMATION (n8n) ---
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_SECURE_COOKIE=false
    volumes:
      - ./n8n:/home/node/.n8n

volumes:
  open-webui:
  ollama_data: