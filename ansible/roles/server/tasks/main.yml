---
# --- 1. DOCKER SETUP ---
- name: Install gnupg (required for key de-armoring)
  apt:
    name: gnupg
    state: present

- name: Download Docker GPG key
  get_url:
    url: https://download.docker.com/linux/ubuntu/gpg
    dest: /tmp/docker.gpg
    mode: '0644'
    force: yes

- name: Dearmor Docker GPG key
  shell: gpg --dearmor < /tmp/docker.gpg > /usr/share/keyrings/docker-archive-keyring.gpg
  # Removed 'creates' to force update of key if it's broken or old

- name: Remove existing Docker repository file to avoid conflicts
  file:
    path: /etc/apt/sources.list.d/docker.list
    state: absent

- name: Add Docker Repository
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present
    filename: docker

- name: Install Docker Components
  apt:
    name: [docker-ce, docker-ce-cli, containerd.io, docker-buildx-plugin, docker-compose-plugin]
    state: present

# --- 2. NVIDIA DRIVERS (The 3080 Pass-Through) ---
- name: Install Nvidia Headless Server Drivers
  apt:
    name: nvidia-driver-535-server
    state: present
  register: nvidia_driver

- name: Download Nvidia GPG Key
  get_url:
    url: https://nvidia.github.io/libnvidia-container/gpgkey
    dest: /tmp/nvidia.pub
    mode: '0644'
    force: yes

- name: Dearmor Nvidia GPG Key
  shell: gpg --dearmor < /tmp/nvidia.pub > /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
  # Removed 'creates' to force update of key if it's broken or old

- name: Remove existing Nvidia repository file to avoid conflicts
  file:
    path: /etc/apt/sources.list.d/nvidia-container-toolkit.list
    state: absent

- name: Add Nvidia Toolkit Repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://nvidia.github.io/libnvidia-container/stable/deb/amd64 /"
    state: present
    filename: nvidia-container-toolkit

- name: Install Nvidia Container Toolkit
  apt:
    name: nvidia-container-toolkit
    state: present

- name: Configure Docker to use Nvidia Runtime
  shell: nvidia-ctk runtime configure --runtime=docker
  # In a real scenario we'd use a handler, but defining it here for simplicity or ensuring it runs
  notify: Restart Docker

- name: Add user to Docker group
  user:
    name: "{{ user_name }}"
    groups: docker
    append: yes

# --- 3. DEPLOYMENT (Clone the Repo) ---
- name: Clone Construct Monorepo
  become_user: "{{ user_name }}"
  git:
    repo: "{{ repo_url | default('https://github.com/Einlanzerous/construct-server.git') }}"
    dest: "/home/{{ user_name }}/construct"
    version: main
    force: yes
