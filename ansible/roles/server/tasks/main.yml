---
# --- 1. DOCKER SETUP ---
- name: Install gnupg (required for key de-armoring)
  apt:
    name: gnupg
    state: present

- name: Download Docker GPG key
  get_url:
    url: https://download.docker.com/linux/ubuntu/gpg
    dest: /tmp/docker.gpg
    mode: '0644'
    force: yes

- name: Dearmor Docker GPG key
  shell: gpg --dearmor < /tmp/docker.gpg > /usr/share/keyrings/docker-archive-keyring.gpg
  # Removed 'creates' to force update of key if it's broken or old

- name: Remove existing Docker repository file to avoid conflicts
  file:
    path: /etc/apt/sources.list.d/docker.list
    state: absent

- name: Add Docker Repository
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present
    filename: docker

- name: Install Docker Components
  apt:
    name: [docker-ce, docker-ce-cli, containerd.io, docker-buildx-plugin, docker-compose-plugin]
    state: present

- name: Install Kernel Headers and DKMS (Required for Nvidia Driver)
  apt:
    name: [linux-headers-generic, mokutil, dkms]
    state: present

- name: Check Secure Boot State
  command: mokutil --sb-state
  register: secure_boot_state
  ignore_errors: yes
  changed_when: false

- name: Fail if Secure Boot is Enabled (Blocks Nvidia Drivers)
  fail:
    msg: "CRITICAL: Secure Boot is ENABLED. This prevents the Nvidia driver from loading. Please reboot into your BIOS and DISABLE Secure Boot, then re-run this playbook."
  when: "'SecureBoot enabled' in secure_boot_state.stdout"

# --- 2. NVIDIA DRIVERS (The 3080 Pass-Through) ---
- name: Install Nvidia Headless Server Drivers
  apt:
    name: nvidia-driver-535-server
    state: present
  register: nvidia_driver
  notify: Reboot Server

# Verify driver state (will fail if not loaded, prompting investigation)
- name: Verify Nvidia Driver connection (nvidia-smi)
  command: nvidia-smi
  register: nvidia_smi_check
  ignore_errors: yes
  changed_when: false

- name: Warn if Nvidia Driver is not loaded
  debug:
    msg: "WARNING: nvidia-smi failed. Drivers may not be loaded. Ensure Secure Boot is disabled or MOK is enrolled. You may need to run 'sudo update-initramfs -u' and reboot."
  when: nvidia_smi_check.rc != 0

- name: Download Nvidia GPG Key
  get_url:
    url: https://nvidia.github.io/libnvidia-container/gpgkey
    dest: /tmp/nvidia.pub
    mode: '0644'
    force: yes

- name: Dearmor Nvidia GPG Key
  shell: gpg --dearmor < /tmp/nvidia.pub > /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
  # Removed 'creates' to force update of key if it's broken or old

- name: Remove existing Nvidia repository file to avoid conflicts
  file:
    path: /etc/apt/sources.list.d/nvidia-container-toolkit.list
    state: absent

- name: Add Nvidia Toolkit Repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://nvidia.github.io/libnvidia-container/stable/deb/amd64 /"
    state: present
    filename: nvidia-container-toolkit

- name: Install Nvidia Container Toolkit
  apt:
    name: nvidia-container-toolkit
    state: present

- name: Generate CDI specification (Force modern mode)
  shell: nvidia-ctk cdi generate --output=/etc/cdi/nvidia.yaml
  notify: Restart Docker

- name: Configure Docker to use Nvidia Runtime
  shell: nvidia-ctk runtime configure --runtime=docker
  # In a real scenario we'd use a handler, but defining it here for simplicity or ensuring it runs
  notify: Restart Docker

- name: Add user to Docker group
  user:
    name: "{{ user_name }}"
    groups: docker
    append: yes

- name: Ensure /data directory is owned by user (for Copyparty)
  file:
    path: /data
    state: directory
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: '0755'

- name: Ensure homer directory is owned by user
  file:
    path: "/home/{{ user_name }}/construct-server/homer"
    state: directory
    recurse: yes
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: '0755'

# --- 3. DEPLOYMENT (Clone the Repo) ---
- name: Clone Construct Monorepo
  become_user: "{{ user_name }}"
  git:
    repo: "{{ repo_url | default('https://github.com/Einlanzerous/construct-server.git') }}"
    dest: "/home/{{ user_name }}/construct-server"
    version: main
    force: yes

- name: Read .env file contents
  set_fact:
    env_file_content: "{{ lookup('file', playbook_dir + '/../.env') }}"

- name: Validate required .env keys are present
  assert:
    that:
      - "env_file_content is search(item)"
    fail_msg: "Missing required key '{{ item }}' in .env file"
  loop:
    - DD_API_KEY
    - DD_SITE
    - DD_TAGS
    - SEMAPHORE_ADMIN_PASSWORD
    - SEMAPHORE_ADMIN_NAME
    - SEMAPHORE_ADMIN_EMAIL
    - SEMAPHORE_ADMIN
    - GITHUB_USER
    - GITHUB_PAT
    - POSTGRES_PASSWORD
    - VOX_LOOP_DB_PASSWORD
    - COOK_BOOK_DB_PASSWORD

- name: Copy .env file to server
  copy:
    src: "{{ playbook_dir }}/../.env"
    dest: "/home/{{ user_name }}/construct-server/.env"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: '0600'
    force: yes
  notify: Restart Docker

- name: Ensure config directory exists
  file:
    path: "/home/{{ user_name }}/construct-server/config"
    state: directory
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: '0755'

- name: Create copyparty configuration
  copy:
    dest: "/home/{{ user_name }}/construct-server/config/copyparty.conf"
    content: |
      [global]
        # e = idk

      [/]
        /w
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: '0644'

- name: Patch docker-compose.yml to mount copyparty config
  lineinfile:
    path: "/home/{{ user_name }}/construct-server/docker-compose.yml"
    insertafter: '      - /data:/w/hdd'
    line: '      - ./config/copyparty.conf:/cfg/copyparty.conf'
    state: present

- name: Ensure construct_net Docker network exists
  community.docker.docker_network:
    name: construct_net
    driver: bridge
    state: present

- name: Load .env variables
  slurp:
    src: "/home/{{ user_name }}/construct-server/.env"
  register: env_file_raw

- name: Parse .env into facts
  set_fact:
    dotenv: "{{ dict(env_file_raw.content | b64decode | regex_findall('(?m)^([A-Z_]+)=(.*)$')) }}"

- name: Log in to GitHub Container Registry
  become_user: "{{ user_name }}"
  shell: echo "{{ dotenv.GITHUB_PAT }}" | docker login ghcr.io -u "{{ dotenv.GITHUB_USER }}" --password-stdin
  no_log: true
  changed_when: false

- name: Start Docker Stack
  become_user: "{{ user_name }}"
  shell: docker compose up -d
  args:
    chdir: "/home/{{ user_name }}/construct-server"
  register: docker_stack_start
  changed_when: "'Running' not in docker_stack_start.stdout"

- name: Pull Ollama Models
  become_user: "{{ user_name }}"
  command: "docker exec ollama ollama pull {{ item }}"
  loop:
    - gemma3:4b
    - gemma3:12b
    - mistral-nemo
    - qwen2.5-coder:7b
  register: ollama_pull
  changed_when: "'success' in ollama_pull.stdout"
  ignore_errors: yes
